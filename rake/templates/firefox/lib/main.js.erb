var pageMod = require('page-mod');
var careplaneWorker = require('Worker');
var data = require('self').data;
var Widget = require('widget').Widget;
var Panel = require('panel').Panel;

var Careplane = require('Careplane').Careplane;

var widget, careplanePanel, panelWorker, modWorker;

careplanePanel = Panel({
  id: 'careplane-panel',
  contentURL: data.url('widget.html'),
  contentScriptFile: data.url('widget.js'),
  onShow: function() {
    careplanePanel.port.emit('preferences.load', {<% CareplaneConfig.drivers.each do |driver| %>
      'sites.<%= driver %>': panelWorker.getPreference({ key: 'sites.<%= driver %>', defaultValue: true }), <% end %>
    });
  }
});

panelWorker = new careplaneWorker.firefoxPanel(careplanePanel);
panelWorker.init();

widget = Widget({
  id: 'careplane-widget',
  label: 'Configure Careplane',
  panel: careplanePanel,
  contentURL: data.url('icon.png'),
  onClick: function() {
    careplanePanel.port.emit('info');
  }
});

<% CareplaneConfig.drivers.each do |driver| %>
  var <%= driver %> = require('drivers/<%= driver %>').<%= driver %>;
  <% content_scripts = CareplaneConfig.content_script_files('firefox', driver) %>
  <% content_scripts = CareplaneConfig.content_script_files('firefox', 'Kayak') + content_scripts if driver == 'KayakUK' %>
  pageMod.PageMod({
    include: <%= driver %>.monitorURL,
    contentScriptWhen: 'ready',
    contentScriptFile: [<% content_scripts.each do |js_file| %>
      data.url('<%= js_file.sub /^src\//,'' %>'),<% end %>
    ],
    contentScript: '(new FirefoxExtension(document)).loadDriver();',
    onAttach: function(addon) {
      modWorker = new careplaneWorker.firefoxMod(addon, careplanePanel);
      modWorker.init('<%= driver %>');
    }
  });
<% end %>
